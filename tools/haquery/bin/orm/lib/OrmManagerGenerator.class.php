<?php

class OrmManagerGenerator {
	public function __construct(){}
	static function make($table, $basePath, $modelFullClassName, $customManagerFullClassName, $autoGenManagerFullClassName) {
		$GLOBALS['%s']->push("OrmManagerGenerator::make");
		$製pos = $GLOBALS['%s']->length;
		$basePath = rtrim(str_replace("\\", "/", $basePath), "/") . "/";
		php_Lib::println("");
		php_Lib::println($table . " => " . $customManagerFullClassName);
		$vars = OrmTools::fields2vars(haquery_server_db_HaqDb::$connection->getFields($table));
		$autoGeneratedManager = OrmManagerGenerator::getAutoGeneratedManager($table, $vars, $modelFullClassName, $autoGenManagerFullClassName, null);
		php_io_File::putContent($basePath . str_replace(".", "/", $autoGenManagerFullClassName) . ".hx", $autoGeneratedManager->toString());
		$customManager = OrmManagerGenerator::getCustomManager($table, $vars, $modelFullClassName, $customManagerFullClassName, $autoGenManagerFullClassName);
		$pathToCustomManager = $basePath . str_replace(".", "/", $customManagerFullClassName) . ".hx";
		if(!file_exists($pathToCustomManager)) {
			php_io_File::putContent($pathToCustomManager, $customManager->toString());
		}
		$GLOBALS['%s']->pop();
	}
	static function getAutoGeneratedManager($table, $vars, $modelFullClassName, $fullClassName, $baseFullClassName) {
		$GLOBALS['%s']->push("OrmManagerGenerator::getAutoGeneratedManager");
		$製pos = $GLOBALS['%s']->length;
		$model = new OrmHaxeClass($fullClassName, $baseFullClassName);
		$model->addImport("php.db.ResultSet");
		$model->addImport("haquery.server.db.HaqDb");
		$model->addMethod("new", new _hx_array(array()), "Void", "", null, null);
		$model->addMethod("newModelFromParams", $vars, $modelFullClassName, "var _obj = new " . $modelFullClassName . "();\x0A" . Lambda::map($vars, array(new _hx_lambda(array(&$baseFullClassName, &$fullClassName, &$model, &$modelFullClassName, &$table, &$vars), "OrmManagerGenerator_0"), 'execute'))->join("\x0A") . "\x0A" . "return _obj;", true, null);
		$model->addMethod("newModelFromRow", new _hx_array(array(OrmTools::createVar("d", "Dynamic", null))), $modelFullClassName, "var _obj = new " . $modelFullClassName . "();\x0A" . Lambda::map($vars, array(new _hx_lambda(array(&$baseFullClassName, &$fullClassName, &$model, &$modelFullClassName, &$table, &$vars), "OrmManagerGenerator_1"), 'execute'))->join("\x0A") . "\x0A" . "return _obj;", true, null);
		$getVars = Lambda::filter($vars, array(new _hx_lambda(array(&$baseFullClassName, &$fullClassName, &$model, &$modelFullClassName, &$table, &$vars), "OrmManagerGenerator_2"), 'execute'));
		if($getVars->length > 0) {
			$model->addMethod("get", $getVars, $modelFullClassName, "return getObjectBySql('SELECT * FROM `" . $table . "`" . OrmManagerGenerator::getWhereSql($getVars) . ");", null, null);
		}
		$createVars = Lambda::filter($vars, array(new _hx_lambda(array(&$baseFullClassName, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars), "OrmManagerGenerator_3"), 'execute'));
		$foreignKeys = haquery_server_db_HaqDb::$connection->getForeignKeys($table);
		$foreignKeyVars = Lambda::filter($vars, array(new _hx_lambda(array(&$baseFullClassName, &$createVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars), "OrmManagerGenerator_4"), 'execute'));
		$model->addMethod("create", $createVars, $modelFullClassName, (OrmManagerGenerator_5($baseFullClassName, $createVars, $foreignKeyVars, $foreignKeys, $fullClassName, $getVars, $model, $modelFullClassName, $table, $vars)) . "HaqDb.query('INSERT INTO `" . $table . "`(" . Lambda::map($createVars, array(new _hx_lambda(array(&$baseFullClassName, &$createVars, &$foreignKeyVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars), "OrmManagerGenerator_6"), 'execute'))->join(", ") . ") VALUES (' + " . Lambda::map($createVars, array(new _hx_lambda(array(&$baseFullClassName, &$createVars, &$foreignKeyVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars), "OrmManagerGenerator_7"), 'execute'))->join(" + ', ' + ") . " + ')');\x0A" . "if (HaqDb.affectedRows() < 1) return null;\x0A" . "return newModelFromParams(" . Lambda::map($vars, array(new _hx_lambda(array(&$baseFullClassName, &$createVars, &$foreignKeyVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars), "OrmManagerGenerator_8"), 'execute'))->join(", ") . ");", null, null);
		$deleteVars = Lambda::filter($vars, array(new _hx_lambda(array(&$baseFullClassName, &$createVars, &$foreignKeyVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars), "OrmManagerGenerator_9"), 'execute'));
		if($deleteVars->length === 0) {
			$deleteVars = $vars;
		}
		$model->addMethod("delete", $deleteVars, "Void", "HaqDb.query('DELETE FROM `" . $table . "`" . OrmManagerGenerator::getWhereSql($deleteVars) . " + ' LIMIT 1');", null, null);
		$model->addMethod("getAll", new _hx_array(array(OrmTools::createVar("_order", "String", OrmManagerGenerator::getOrderDefVal($vars)))), "Array<" . $modelFullClassName . ">", "return getObjectsBySql('SELECT * FROM `" . $table . "`' + (_order != null ? ' ORDER BY ' + _order : ''));", null, null);
		$model->addMethod("getObjectBySql", new _hx_array(array(OrmTools::createVar("sql", "String", null))), $modelFullClassName, "var rows : ResultSet = HaqDb.query(sql + ' LIMIT 1');\x0A" . "if (rows.length == 0) return null;\x0A" . "return newModelFromRow(rows.next());", null, null);
		$model->addMethod("getObjectsBySql", new _hx_array(array(OrmTools::createVar("sql", "String", null))), "Array<" . $modelFullClassName . ">", "var rows : ResultSet = HaqDb.query(sql);\x0A" . "var list : Array<" . $modelFullClassName . "> = [];\x0A" . "for (row in rows)\x0A" . "{\x0A" . "\x09list.push(newModelFromRow(row));\x0A" . "}\x0A" . "return list;", null, null);
		{
			$_g = 0; $_g1 = haquery_server_db_HaqDb::$connection->getUniqueFields($table);
			while($_g < $_g1->length) {
				$uniqueField = $_g1[$_g];
				++$_g;
				$vs = Lambda::filter($vars, array(new _hx_lambda(array(&$_g, &$_g1, &$baseFullClassName, &$createVars, &$deleteVars, &$foreignKeyVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$uniqueField, &$vars), "OrmManagerGenerator_10"), 'execute'));
				OrmManagerGenerator::createGetByMethod($table, $vars, $modelFullClassName, $vs, $model);
				unset($vs,$uniqueField);
			}
		}
		if(null == OrmManagerGenerator::getForeignKeyVars($table, $vars)) throw new HException('null iterable');
		$蜴t = OrmManagerGenerator::getForeignKeyVars($table, $vars)->iterator();
		while($蜴t->hasNext()) {
			$v = $蜴t->next();
			OrmManagerGenerator::createGetsByMethod($table, $vars, $modelFullClassName, new _hx_array(array($v)), $model);
		}
		{
			$GLOBALS['%s']->pop();
			return $model;
		}
		$GLOBALS['%s']->pop();
	}
	static function getCustomManager($table, $vars, $modelFullClassName, $fullClassName, $baseFullClassName) {
		$GLOBALS['%s']->push("OrmManagerGenerator::getCustomManager");
		$製pos = $GLOBALS['%s']->length;
		$model = new OrmHaxeClass($fullClassName, $baseFullClassName);
		$clas = OrmTools::splitFullClassName($fullClassName);
		$model->addImport("haquery.server.db.HaqDb");
		$model->addImport($modelFullClassName);
		{
			$GLOBALS['%s']->pop();
			return $model;
		}
		$GLOBALS['%s']->pop();
	}
	static function createGetByMethod($table, $vars, $modelFullClassName, $whereVars, $model) {
		$GLOBALS['%s']->push("OrmManagerGenerator::createGetByMethod");
		$製pos = $GLOBALS['%s']->length;
		if($whereVars === null || $whereVars->length === 0) {
			$GLOBALS['%s']->pop();
			return;
		}
		$model->addMethod("getBy" . Lambda::map($whereVars, array(new _hx_lambda(array(&$model, &$modelFullClassName, &$table, &$vars, &$whereVars), "OrmManagerGenerator_11"), 'execute'))->join("And"), $whereVars, $modelFullClassName, "return getObjectBySql('SELECT * FROM `" . $table . "`" . OrmManagerGenerator::getWhereSql($whereVars) . ");", null, null);
		$GLOBALS['%s']->pop();
	}
	static function createGetsByMethod($table, $vars, $modelFullClassName, $whereVars, $model) {
		$GLOBALS['%s']->push("OrmManagerGenerator::createGetsByMethod");
		$製pos = $GLOBALS['%s']->length;
		if($whereVars === null || !$whereVars->iterator()->hasNext()) {
			$GLOBALS['%s']->pop();
			return;
		}
		$model->addMethod("getBy" . Lambda::map($whereVars, array(new _hx_lambda(array(&$model, &$modelFullClassName, &$table, &$vars, &$whereVars), "OrmManagerGenerator_12"), 'execute'))->join("And"), Lambda::concat($whereVars, new _hx_array(array(OrmTools::createVar("_order", "String", OrmManagerGenerator::getOrderDefVal($vars))))), "Array<" . $modelFullClassName . ">", "return getObjectsBySql('SELECT * FROM `" . $table . "`" . OrmManagerGenerator::getWhereSql($whereVars) . " + (_order != null ? ' ORDER BY ' + _order : ''));", null, null);
		$GLOBALS['%s']->pop();
	}
	static function getOrderDefVal($vars) {
		$GLOBALS['%s']->push("OrmManagerGenerator::getOrderDefVal");
		$製pos = $GLOBALS['%s']->length;
		$positionVar = Lambda::filter($vars, array(new _hx_lambda(array(&$vars), "OrmManagerGenerator_13"), 'execute'));
		{
			$裨mp = OrmManagerGenerator_14($positionVar, $vars);
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
	static function getWhereSql($vars) {
		$GLOBALS['%s']->push("OrmManagerGenerator::getWhereSql");
		$製pos = $GLOBALS['%s']->length;
		{
			$裨mp = " WHERE " . Lambda::map($vars, array(new _hx_lambda(array(&$vars), "OrmManagerGenerator_15"), 'execute'))->join("+' AND ");
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
	static function getForeignKeyVars($table, $vars) {
		$GLOBALS['%s']->push("OrmManagerGenerator::getForeignKeyVars");
		$製pos = $GLOBALS['%s']->length;
		$foreignKeys = haquery_server_db_HaqDb::$connection->getForeignKeys($table);
		$foreignKeyVars = Lambda::filter($vars, array(new _hx_lambda(array(&$foreignKeys, &$table, &$vars), "OrmManagerGenerator_16"), 'execute'));
		{
			$GLOBALS['%s']->pop();
			return $foreignKeyVars;
		}
		$GLOBALS['%s']->pop();
	}
	function __toString() { return 'OrmManagerGenerator'; }
}
function OrmManagerGenerator_0(&$baseFullClassName, &$fullClassName, &$model, &$modelFullClassName, &$table, &$vars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getAutoGeneratedManager@45");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = "_obj." . $v->haxeName . " = " . $v->haxeName . ";";
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_1(&$baseFullClassName, &$fullClassName, &$model, &$modelFullClassName, &$table, &$vars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getAutoGeneratedManager@52");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = "_obj." . $v->haxeName . " = Reflect.field(d, '" . $v->haxeName . "');";
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_2(&$baseFullClassName, &$fullClassName, &$model, &$modelFullClassName, &$table, &$vars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getAutoGeneratedManager@57");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = $v->isKey;
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_3(&$baseFullClassName, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getAutoGeneratedManager@65");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = !$v->isAutoInc;
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_4(&$baseFullClassName, &$createVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getAutoGeneratedManager@67");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = !$v->isAutoInc;
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_5(&$baseFullClassName, &$createVars, &$foreignKeyVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars) {
	$製pos = $GLOBALS['%s']->length;
	if(Lambda::exists($createVars, array(new _hx_lambda(array(&$baseFullClassName, &$createVars, &$foreignKeyVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars), "OrmManagerGenerator_17"), 'execute'))) {
		return "if (position == null)\x0A" . "{\x0A" . "\x09position = HaqDb.query('SELECT MAX(`position`) FROM `" . $table . "`" . OrmManagerGenerator::getWhereSql(OrmManagerGenerator::getForeignKeyVars($table, $vars)) . ").getIntResult(0) + 1;\x0A" . "}\x0A\x0A";
	} else {
		return "";
	}
}
function OrmManagerGenerator_6(&$baseFullClassName, &$createVars, &$foreignKeyVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getAutoGeneratedManager@80");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = "`" . $v->name . "`";
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_7(&$baseFullClassName, &$createVars, &$foreignKeyVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getAutoGeneratedManager@82");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = "HaqDb.quote(" . $v->haxeName . ")";
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_8(&$baseFullClassName, &$createVars, &$foreignKeyVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getAutoGeneratedManager@85");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = OrmManagerGenerator_18($baseFullClassName, $createVars, $foreignKeyVars, $foreignKeys, $fullClassName, $getVars, $model, $modelFullClassName, $table, $v, $vars);
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_9(&$baseFullClassName, &$createVars, &$foreignKeyVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getAutoGeneratedManager@88");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = $v->isKey;
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_10(&$_g, &$_g1, &$baseFullClassName, &$createVars, &$deleteVars, &$foreignKeyVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$uniqueField, &$vars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getAutoGeneratedManager@116");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = $v->name === $uniqueField;
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_11(&$model, &$modelFullClassName, &$table, &$vars, &$whereVars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::createGetByMethod@144");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = OrmTools::capitalize($v->haxeName);
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_12(&$model, &$modelFullClassName, &$table, &$vars, &$whereVars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::createGetsByMethod@157");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = OrmTools::capitalize($v->haxeName);
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_13(&$vars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getOrderDefVal@167");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = $v->name === "position";
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_14(&$positionVar, &$vars) {
	$製pos = $GLOBALS['%s']->length;
	if($positionVar->isEmpty()) {
		return "null";
	} else {
		return "'" . $positionVar->first()->haxeName . "'";
	}
}
function OrmManagerGenerator_15(&$vars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getWhereSql@173");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = "`" . $v->name . "` = ' + HaqDb.quote(" . $v->haxeName . ")";
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_16(&$foreignKeys, &$table, &$vars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getForeignKeyVars@179");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = Lambda::exists($foreignKeys, array(new _hx_lambda(array(&$foreignKeys, &$table, &$v, &$vars), "OrmManagerGenerator_19"), 'execute'));
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_17(&$baseFullClassName, &$createVars, &$foreignKeyVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$vars, $v) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getForeignKeyVars@70");
		$製pos2 = $GLOBALS['%s']->length;
		{
			$裨mp = $v->name === "position";
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
function OrmManagerGenerator_18(&$baseFullClassName, &$createVars, &$foreignKeyVars, &$foreignKeys, &$fullClassName, &$getVars, &$model, &$modelFullClassName, &$table, &$v, &$vars) {
	$製pos = $GLOBALS['%s']->length;
	if($v->isAutoInc) {
		return "HaqDb.lastInsertId()";
	} else {
		return $v->haxeName;
	}
}
function OrmManagerGenerator_19(&$foreignKeys, &$table, &$v, &$vars, $fk) {
	$製pos = $GLOBALS['%s']->length;
	{
		$GLOBALS['%s']->push("OrmManagerGenerator::getForeignKeyVars@180");
		$製pos3 = $GLOBALS['%s']->length;
		{
			$裨mp = $fk->key === $v->name;
			$GLOBALS['%s']->pop();
			return $裨mp;
		}
		$GLOBALS['%s']->pop();
	}
}
